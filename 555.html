<script>
    const cells = Array.from(document.querySelectorAll('.cell'));
    const scoreElement = document.getElementById('score');
    const clickCountElement = document.getElementById('clickCount');
    const winCountElement = document.getElementById('winCount');
    const lossCountElement = document.getElementById('lossCount');
    const playButton = document.getElementById('playButton');
    const restartButton = document.getElementById('restartButton');

    const messages = {
        horizontal: document.getElementById('horizontalMessage'),
        vertical: document.getElementById('verticalMessage'),
        diagonal: document.getElementById('diagonalMessage'),
        total: document.getElementById('totalPointsMessage'),
        end: document.getElementById('endMessage')
    };

    let score = 30;
    let clickCount = 0;
    let winCount = 0;
    let lossCount = 0;

    function updateScore(points) {
        score += points;
        scoreElement.textContent = score;
    }

    function resetMessages() {
        document.getElementById('horizontalResult').textContent = '';
        document.getElementById('verticalResult').textContent = '';
        document.getElementById('diagonalResult').textContent = '';
        document.getElementById('totalResult').textContent = '';
        messages.end.textContent = '';
    }

    async function flashCells(cellsToFlash, colorClass, delay = 0) {
        return new Promise((resolve) => {
            setTimeout(() => {
                cellsToFlash.forEach(cell => cell.classList.add(colorClass));
            }, delay);

            setTimeout(() => {
                cellsToFlash.forEach(cell => cell.classList.remove(colorClass));
                resolve();
            }, delay + 300);
        });
    }

    async function checkHorizontal() {
        let points = 0;
        let matchInfo = [];
        for (let i = 0; i < 9; i += 3) {
            const row = [cells[i], cells[i + 1], cells[i + 2]];
            const values = row.map(cell => cell.textContent);
            const counts = {};

            values.forEach(value => {
                counts[value] = (counts[value] || 0) + 1;
            });

            if (Object.values(counts).includes(3)) {
                points += 5;
                await flashCells(row, 'highlight-green');
                matchInfo.push("+5");
            } else if (Object.values(counts).includes(2)) {
                points += 3;
                await flashCells(row.filter(cell => counts[cell.textContent] === 2), 'highlight-green');
                matchInfo.push("+3");
            } else {
                matchInfo.push("0");
            }
        }

        document.getElementById('horizontalResult').textContent = matchInfo.join(", ");
        return points;
    }

    async function checkVertical() {
        let points = 0;
        let matchInfo = [];
        for (let i = 0; i < 3; i++) {
            const column = [cells[i], cells[i + 3], cells[i + 6]];
            const values = column.map(cell => cell.textContent);
            const counts = {};

            values.forEach(value => {
                counts[value] = (counts[value] || 0) + 1;
            });

            if (Object.values(counts).includes(3)) {
                points += 5;
                await flashCells(column, 'highlight-blue', 300);
                matchInfo.push("+5");
            } else if (Object.values(counts).includes(2)) {
                points += 3;
                await flashCells(column.filter(cell => counts[cell.textContent] === 2), 'highlight-blue', 300);
                matchInfo.push("+3");
            } else {
                matchInfo.push("0");
            }
        }

        document.getElementById('verticalResult').textContent = matchInfo.join(", ");
        return points;
    }

    async function checkDiagonal() {
        let points = 0;
        const mainDiagonal = [cells[0], cells[4], cells[8]];
        const antiDiagonal = [cells[2], cells[4], cells[6]];
        const diagonals = [mainDiagonal, antiDiagonal];
        let matchInfo = [];

        for (const diagonal of diagonals) {
            const values = diagonal.map(cell => cell.textContent);
            const counts = {};

            values.forEach(value => {
                counts[value] = (counts[value] || 0) + 1;
            });

            if (Object.values(counts).includes(3)) {
                points += 6;
                await flashCells(diagonal, 'highlight-yellow', 300);
                matchInfo.push("+6");
            } else if (Object.values(counts).includes(2)) {
                points += 4;
                await flashCells(diagonal.filter(cell => counts[cell.textContent] === 2), 'highlight-yellow', 300);
                matchInfo.push("+4");
            } else {
                matchInfo.push("0");
            }
        }

        document.getElementById('diagonalResult').textContent = matchInfo.join(", ");
        return points;
    }

    async function playGame() {
        playButton.disabled = true;
        resetMessages();

        // Заполнение ячеек случайными числами
        cells.forEach(cell => cell.textContent = Math.floor(Math.random() * 10));
        clickCount++;
        clickCountElement.textContent = clickCount;

        // Подсчёт очков
        const horizontalPoints = await checkHorizontal();
        const verticalPoints = await checkVertical();
        const diagonalPoints = await checkDiagonal();

        const totalPoints = horizontalPoints + verticalPoints + diagonalPoints;

        if (totalPoints > 0) {
            document.getElementById('totalResult').textContent = totalPoints;
            updateScore(totalPoints);
        } else {
            document.getElementById('totalResult').textContent = "-8 (нет совпадений)";
            updateScore(-8);
        }

        // Проверка состояния игры
        if (score >= 200) {
            winCount++;
            winCountElement.textContent = winCount;
            messages.end.textContent = "Вы выиграли!";
            playButton.disabled = true;
            restartButton.style.display = 'block';
        } else if (clickCount >= 22) {
            if (score < 200) {
                lossCount++;
                lossCountElement.textContent = lossCount;
                messages.end.textContent = "Вы проиграли! Не хватило очков.";
            } else {
                winCount++;
                winCountElement.textContent = winCount;
                messages.end.textContent = "Вы выиграли! Набрано 200 очков.";
            }
            playButton.disabled = true;
            restartButton.style.display = 'block';
        } else {
            playButton.disabled = false;
        }
    }

    playButton.addEventListener('click', playGame);

    restartButton.addEventListener('click', () => {
        score = 30;
        clickCount = 0;
        document.getElementById('score').textContent = score;
        document.getElementById('clickCount').textContent = clickCount;

        resetMessages();

        cells.forEach(cell => {
            cell.textContent = '';
        });

        restartButton.style.display = 'none';
        playButton.disabled = false;
        messages.end.textContent = '';
    });
</script>
