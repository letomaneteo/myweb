<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>React Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    const App = () => {
      const [score, setScore] = useState(30);
      const [clickCount, setClickCount] = useState(0);
      const [winCount, setWinCount] = useState(0);
      const [lossCount, setLossCount] = useState(0);
      const [userScore, setUserScore] = useState(0);
      const [userLevel, setUserLevel] = useState(1);
      const [gameMessage, setGameMessage] = useState('');
      const [loading, setLoading] = useState(true);

      const telegramId = new URLSearchParams(window.location.search).get('telegram_id');
      const username = new URLSearchParams(window.location.search).get('username');

      useEffect(() => {
        if (telegramId && username) {
          const greeting = `Здравствуйте, ${username} (${telegramId})`;
          console.log(greeting);
          fetchUserStats();
        }
      }, [telegramId, username]);

      const fetchUserStats = async () => {
        try {
          const response = await fetch(`https://dbf3-213-109-225-82.ngrok-free.app/get_user?user_id=${telegramId}`);
          const data = await response.json();
          setUserScore(data.score);
          setUserLevel(data.level || 1);
          setLoading(false);
        } catch (err) {
          console.error('Ошибка при загрузке данных:', err);
        }
      };

      const sendStatsToServer = async () => {
        const payload = {
          user_id: telegramId,
          wins: winCount,
          losses: lossCount
        };

        try {
          const response = await fetch("https://dbf3-213-109-225-82.ngrok-free.app/update_user_data", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });
          const data = await response.json();
          setUserScore(data.score);
          setUserLevel(data.level);
          console.log('Данные пользователя обновлены:', data);
        } catch (error) {
          console.error('Ошибка при отправке данных на сервер:', error);
        }
      };

      const playGame = () => {
        setClickCount(clickCount + 1);
        setScore(score + Math.floor(Math.random() * 10) - 5); // Пример для случайного изменения очков
        if (score >= 200) {
          setWinCount(winCount + 1);
          setGameMessage('Вы выиграли!');
          sendStatsToServer();
        } else if (clickCount >= 22) {
          setLossCount(lossCount + 1);
          setGameMessage('Вы проиграли!');
          sendStatsToServer();
        }
      };

      return (
        <div className="App">
          <h1>Добро пожаловать, {username}!</h1>
          <p>Ваши очки: {userScore}</p>
          <p>Ваш уровень: {userLevel}</p>
          <p>Победы: {winCount}</p>
          <p>Поражения: {lossCount}</p>
          <p>{gameMessage}</p>
          <button onClick={playGame}>Играть</button>
          <button onClick={sendStatsToServer}>Обновить данные</button>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
