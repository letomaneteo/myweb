<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Игра React с сервером</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 10px;
      margin: 20px;
    }

    .cell {
      width: 80px;
      height: 80px;
      border: 2px solid #000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      background-color: #f0f0f0;
    }

    .play-button, .restart-button {
      padding: 10px 20px;
      margin: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    const SERVER_URL = "https://dbf3-213-109-225-82.ngrok-free.app";

    const App = () => {
      const [userData, setUserData] = useState({ id: "", username: "", score: 0, level: 1 });
      const [grid, setGrid] = useState(Array(9).fill(""));
      const [clickCount, setClickCount] = useState(0);
      const [winCount, setWinCount] = useState(0);
      const [lossCount, setLossCount] = useState(0);

      // Получение данных пользователя из URL
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get("telegram_id") || "guest";
        const username = params.get("username") || "Гость";

        fetch(`${SERVER_URL}/get_user_data?telegram_id=${userId}`)
          .then((res) => res.json())
          .then((data) => {
            setUserData({
              id: userId,
              username: username,
              score: data.score || 0,
              level: data.level || 1,
            });
          })
          .catch((err) => console.error("Ошибка загрузки данных:", err));
      }, []);

      const updateServerData = (score, level) => {
        fetch(`${SERVER_URL}/update_user_data`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            telegram_id: userData.id,
            score: score,
            level: level,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            console.log("Обновлены данные пользователя:", data);
            setUserData((prev) => ({ ...prev, score: data.score, level: data.level }));
          })
          .catch((err) => console.error("Ошибка отправки данных:", err));
      };

      const playGame = () => {
        const newGrid = Array(9)
          .fill("")
          .map(() => Math.floor(Math.random() * 10).toString());
        setGrid(newGrid);
        setClickCount((prev) => prev + 1);

        const points = calculateScore(newGrid);

        if (points > 0) {
          setWinCount((prev) => prev + 1);
          const newScore = userData.score + points;
          const newLevel = (winCount + 1) % 3 === 0 ? userData.level + 1 : userData.level;
          updateServerData(newScore, newLevel);
        } else if (clickCount >= 21) {
          setLossCount((prev) => prev + 1);
          const newScore = userData.score - 10;
          updateServerData(newScore, userData.level);
        }
      };

      const calculateScore = (grid) => {
        // Пример подсчета очков: +5 за все одинаковые, -8 за все разные
        const uniqueNumbers = new Set(grid).size;
        if (uniqueNumbers === 1) return 5;
        return -8;
      };

      return (
        <div>
          <h1>Здравствуйте, {userData.username}!</h1>
          <p>Очки: {userData.score} | Уровень: {userData.level}</p>
          <p>Победы: {winCount} | Поражения: {lossCount}</p>
          <p>Клики: {clickCount}/22</p>

          <div className="grid">
            {grid.map((cell, idx) => (
              <div key={idx} className="cell">
                {cell}
              </div>
            ))}
          </div>

          <button onClick={playGame} className="play-button" disabled={clickCount >= 22}>
            Играть
          </button>
          <button
            onClick={() => {
              setGrid(Array(9).fill(""));
              setClickCount(0);
              setWinCount(0);
              setLossCount(0);
            }}
            className="restart-button"
          >
            Сброс
          </button>
        </div>
      );
    };

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
