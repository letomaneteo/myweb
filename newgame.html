<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Игра React с сервером</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, 80px);
      gap: 10px;
      justify-content: center;
    }

    .cell {
      width: 80px;
      height: 80px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: 2px solid #333;
      background-color: #f0f0f0;
      font-size: 24px;
      font-weight: bold;
    }

    button {
      padding: 10px 20px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    const SERVER_URL = "https://dbf3-213-109-225-82.ngrok-free.app";

    const App = () => {
      const [userData, setUserData] = useState({ id: "", username: "", points: 0, level: 1 });
      const [grid, setGrid] = useState(Array(9).fill(""));
      const [clickCount, setClickCount] = useState(0);

      // Получение данных пользователя
      useEffect(() => {
        const params = new URLSearchParams(window.location.search);
        const userId = params.get("user_id");
        if (userId) {
          fetch(`${SERVER_URL}/get_user?user_id=${userId}`)
            .then((res) => res.json())
            .then((data) => setUserData(data))
            .catch((err) => console.error("Ошибка загрузки данных пользователя:", err));
        }
      }, []);

      const updatePoints = (newPoints) => {
        fetch(`${SERVER_URL}/edit_points`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userData.id, points: newPoints }),
        })
          .then((res) => res.json())
          .then((data) => console.log("Очки обновлены:", data))
          .catch((err) => console.error("Ошибка обновления очков:", err));
      };

      const updateLevel = (newLevel) => {
        fetch(`${SERVER_URL}/edit_level`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id: userData.id, level: newLevel }),
        })
          .then((res) => res.json())
          .then((data) => console.log("Уровень обновлен:", data))
          .catch((err) => console.error("Ошибка обновления уровня:", err));
      };

      const playGame = () => {
        const newGrid = Array(9)
          .fill("")
          .map(() => Math.floor(Math.random() * 10).toString());
        setGrid(newGrid);

        // Логика подсчета очков
        const points = calculatePoints(newGrid);
        const newPoints = userData.points + points;
        const newLevel = points >= 100 ? userData.level + 1 : userData.level;

        setClickCount((prev) => prev + 1);
        setUserData((prev) => ({ ...prev, points: newPoints, level: newLevel }));

        updatePoints(newPoints);
        if (newLevel !== userData.level) {
          updateLevel(newLevel);
        }
      };

      const calculatePoints = (grid) => {
        const uniqueNumbers = new Set(grid).size;
        return uniqueNumbers === 1 ? 10 : -5;
      };

      return (
        <div>
          <h1>Игра</h1>
          <p>Игрок: {userData.username || "Гость"}</p>
          <p>Очки: {userData.points} | Уровень: {userData.level}</p>
          <p>Клики: {clickCount}/22</p>

          <div className="grid">
            {grid.map((value, index) => (
              <div key={index} className="cell">
                {value}
              </div>
            ))}
          </div>

          <button onClick={playGame} disabled={clickCount >= 22}>
            Играть
          </button>
        </div>
      );
    };

    createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
