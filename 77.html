<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>React Game</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.20.12/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const { createRoot } = ReactDOM;

    const App = () => {
      const [points, setPoints] = useState(15);
      const [clicks, setClicks] = useState(0);
      const [wins, setWins] = useState(0);
      const [losses, setLosses] = useState(0);
      const [level, setLevel] = useState(1);
      const [numbers, setNumbers] = useState([0, 0, 0]);

      const updateServer = async (field, value) => {
        const endpointMap = {
          points: 'edit_points',
          level: 'edit_level',
        };

        const endpoint = endpointMap[field];
        if (!endpoint) return;

        try {
          await fetch(`https://a6e3-213-109-225-194.ngrok-free.app/${endpoint}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
            body: JSON.stringify({ user_id: 1, [field]: value }),
          });
        } catch (err) {
          console.error(`Ошибка обновления ${field} на сервере:`, err);
        }
      };

      useEffect(() => {
        updateServer('points', points);
        updateServer('level', level);
      }, [points, level]);

      const playGame = () => {
        const newNumbers = Array.from({ length: 3 }, () => Math.floor(Math.random() * 10));
        setNumbers(newNumbers);
        setClicks((prevClicks) => prevClicks + 1);

        const uniqueNumbers = new Set(newNumbers);
        let pointChange = 0;

        if (uniqueNumbers.size === 1) {
          pointChange = 4;
        } else if (uniqueNumbers.size === 2) {
          pointChange = 3;
        } else {
          pointChange = -2;
        }

        const newPoints = points + pointChange;
        setPoints(newPoints);

        if (newPoints >= 30) {
          setWins((prevWins) => prevWins + 1);
          setPoints(15);
          setClicks(0);

          if ((wins + 1) % 3 === 0) {
            setLevel((prevLevel) => prevLevel + 1);
          }
        } else if (newPoints <= 0 || clicks + 1 > 40) {
          setLosses((prevLosses) => prevLosses + 1);
          setPoints(15);
          setClicks(0);
        }
      };

      return (
        <div style={{ textAlign: "center", fontFamily: "Arial" }}>
          <h1>Три квадрата</h1>
          <p>Очки: {points}</p>
          <p>Клики: {clicks}</p>
          <p>Победы: {wins}</p>
          <p>Поражения: {losses}</p>
          <p>Уровень: {level}</p>
          <div style={{ display: "flex", justifyContent: "center", margin: "20px" }}>
            {numbers.map((num, index) => (
              <div key={index} style={{ 
                width: "50px", 
                height: "50px", 
                border: "1px solid black", 
                display: "flex", 
                alignItems: "center", 
                justifyContent: "center", 
                margin: "0 10px", 
                fontSize: "24px" 
              }}>
                {num}
              </div>
            ))}
          </div>
          <button onClick={playGame} style={{ padding: "10px 20px", fontSize: "16px" }}>Играть</button>
        </div>
      );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
