<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Обновление данных пользователя</title>
    <script>
        // Функция для получения данных пользователя из базы по ID
        async function fetchUserData() {
            const userId = document.getElementById('userId').value; // Получаем ID из поля
            try {
                const response = await fetch(`https://4f52-213-109-225-82.ngrok-free.app/get_data/${userId}`);
                const textResponse = await response.text(); // Получаем ответ как текст
                console.log('Ответ от сервера:', textResponse); // Логируем ответ

                // Попытка распарсить ответ как JSON
                const data = JSON.parse(textResponse);
                displayUserData(data); // Отображаем данные на экране
            } catch (error) {
                console.error('Ошибка при получении данных:', error);
                alert('Ошибка при загрузке данных.');
            }
        }

        // Функция для отображения данных пользователя на экране
        function displayUserData(data) {
            const userDataContainer = document.getElementById('userData');
            userDataContainer.innerHTML = `
                <p><strong>ID:</strong> ${data.id}</p>
                <p><strong>Имя:</strong> ${data.username}</p>
                <p><strong>Очки:</strong> ${data.points}</p>
            `;
            document.getElementById('newPoints').value = ''; // Очистим поле для новых очков
        }

        // Функция для отправки обновленных данных очков на сервер
        async function updatePoints() {
            const userId = document.getElementById('userId').value; // Получаем ID пользователя
            const newPoints = parseInt(document.getElementById('newPoints').value, 10); // Получаем новые очки
            if (isNaN(newPoints)) {
                alert('Пожалуйста, введите корректное значение для очков.');
                return;
            }

            // Получение имени пользователя из ранее загруженных данных
            const username = document.getElementById('userData').querySelector('p:nth-child(2)').innerText.split(': ')[1]; 
            
            if (!username) {
                alert('Имя пользователя не найдено.');
                return;
            }

            const requestData = {
                id: userId,
                username: username,
                points: newPoints
            };

            try {
                const response = await fetch('https://4f52-213-109-225-82.ngrok-free.app/send_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const responseData = await response.json();
                    alert('Очки обновлены успешно!');
                    fetchUserData(); // Перезагружаем данные после обновления
                } else {
                    const errorData = await response.text();
                    console.error('Ошибка при запросе:', errorData);
                    alert('Ошибка при обновлении очков.');
                }
            } catch (error) {
                console.error('Ошибка выполнения запроса:', error);
                alert('Произошла ошибка при обновлении данных.');
            }
        }
    </script>
</head>
<body>
    <h1>Добро пожаловать в личный кабинет</h1>
    
    <label for="userId">Введите ваш ID:</label>
    <input type="text" id="userId" placeholder="Введите ID пользователя">
    <button onclick="fetchUserData()">Загрузить данные</button>
    
    <div id="userData">
        <!-- Данные пользователя будут отображаться здесь -->
    </div>

    <h2>Изменить очки</h2>
    <label for="newPoints">Новые очки:</label>
    <input type="number" id="newPoints" placeholder="Введите новое значение очков">
    <br>
    <button onclick="updatePoints()">Обновить очки</button>
</body>
</html>
